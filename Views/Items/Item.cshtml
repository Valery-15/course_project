@model CollectionsApp.ViewModels.ItemViewModel

@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

<div>
    <div>
        <a class="h2 text-primary" href="/Items/ItemsList?collectionId=@Model.CollectionId">
            @Model.CollectionTitle
        </a><br/><br />
    </div>

    <div class="card" style="width: 18rem;">
        <div class="card-header">
            <label class="h3 text-info">@Model.Title</label><br />
            @if( Model.Tags.Count() != 0)
            {
                foreach(var tag in Model.Tags)
                {
                    <a asp-action="GetItemsByTag" asp-controller="Tags" asp-route-tagId="@tag.Id">
                        #@tag.TagValue
                    </a><br />
                }
            }
        </div>

        <ul class="list-group list-group-flush">
            @foreach (var field in Model.AdditionalFields)
            {
                if (field.InputType.ToLower().Equals("checkbox"))
                {
                    if (field.Value == null)
                    {
                        <li class="list-group-item">@field.Title: no</li>
                    } else
                    {
                        <li class="list-group-item">@field.Title: yes</li>
                    }
                } else
                {
                <li class="list-group-item">@field.Title: @field.Value</li>

                }
            }
            <li class="list-group-item align-content-end">
                <button id="like" style="border:none; background:none;outline:none;color:deeppink"></button>
                <label id="likesNumber"></label>
            </li>
        </ul>
    </div><br />


    @if (SignInManager.IsSignedIn(this.User))
    {
        <div>
            <form method="post" asp-controller="Comments" asp-action="AddComment">
                <input type="hidden" name="itemId" value="@Model.ItemId" />
                <textarea name="body" style="width: 18rem" placeholder="Your comment" required></textarea><br/>
                <input type="submit" class="btn btn-primary" value="Send" />
            </form>
        </div>
    }

    <br />
    <div class="card" style="width: 18rem;">
        <div class="card-header">
            <label class="h4 text-dark" style="font-weight:500">Comments</label>
        </div>
        <div class="card-body">
            <table id="comments">
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    var comments = document.getElementById('comments');
    updateComments();

    function updateComments() {
        var url = '/Comments/GetCommentsList?itemId=@Model.ItemId';
        fetch(url)
            .then(result => result.json())
            .then(commentsList => {
                clearTable(comments, 1);

                commentsList.forEach(comment => {
                    var tr = document.createElement('tr');
                    var td;

                    td = document.createElement('td');
                    td.innerHTML = comment.user.userName + ':  ';
                    td.style = "font-weight:500";
                    tr.appendChild(td);

                    td = document.createElement('td');
                    td.innerHTML = comment.body;
                    tr.appendChild(td);

                    comments.append(tr);
                });
                setTimeout(updateComments, 5000);
            })
            .catch(e => {
                console.log('Error: ', e);
                setTimeout(updateComments, 5000);
            });
    }

    function clearTable(table, offset = 0) {
        if (table.rows != null) {
            let rowCount = table.rows.length;
            for (var i = offset; i < rowCount; i++) {
                table.deleteRow(offset);
            }
        }
    }
</script>

<script>
    var like = document.getElementById('like');
    var likesNumber = document.getElementById('likesNumber');
    var isSignedIn = '@SignInManager.IsSignedIn(this.User)';
    var isUserLikedItem;
    var url;


    function updateLikes() {
        fetch('/Likes/ShowLikes?itemId=@Model.ItemId')
            .then(result => result.json())
            .then(data => {
                console.log(data);
                if (data.isCurrentUserLikedItem) {
                    isUserLikedItem = true;
                    url = '/Likes/RemoveLike?itemId=@Model.ItemId';
                    like.className = "bi bi-heart-fill";
                    console.log('remove like');
                } else {
                    isUserLikedItem = false;
                    url = '/Likes/AddLike?itemId=@Model.ItemId';
                    like.className = "bi bi-heart";
                    console.log('add like');
                }
                likesNumber.innerHTML = data.likesNumber;
            });
        setTimeout(updateLikes, 5000);
    }

    updateLikes();

    if (isSignedIn.toLowerCase() == "true") {
        like.addEventListener("click", function () {
            fetch(url)
                .then(response => response.json())
                .then((data) => {
                    console.log(data);
                    if (data.isCurrentUserLikedItem) {
                        isUserLikedItem = true;
                        url = '/Likes/RemoveLike?itemId=@Model.ItemId';
                        like.className = "bi bi-heart-fill";
                        console.log('removw like ev list');
                    } else {
                        isUserLikedItem = false;
                        url = '/Likes/AddLike?itemId=@Model.ItemId';
                        like.className = "bi bi-heart";
                        console.log('add like ev list');

                    }
                    likesNumber.innerHTML = data.likesNumber;
                    });
        });
    }
</script>

